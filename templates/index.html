<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown to PDF Converter</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- DaisyUI -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.min.css" rel="stylesheet" type="text/css" />

    <style>
        .drop-zone {
            transition: all 0.3s ease;
        }
        .drop-zone.drag-over {
            background-color: rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
        }
        .input-synced {
            background-color: #f0fdf4;
        }
        .input-modified {
            background-color: #fefce8;
        }
    </style>
</head>
<body class="bg-base-200 min-h-screen">
    <div class="container mx-auto p-8 max-w-6xl">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-2">Markdown to PDF Converter</h1>
            <p class="text-base-content/70">Upload markdown files and convert them to beautifully styled PDFs</p>
        </div>

        <!-- Upload Card (MOVED TO TOP) -->
        <div class="card bg-base-100 shadow-xl mb-6">
            <div class="card-body">
                <h2 class="card-title">Upload Markdown File</h2>

                <form id="uploadForm" enctype="multipart/form-data">
                    <div id="dropZone" class="drop-zone border-2 border-dashed border-base-300 rounded-lg p-12 text-center cursor-pointer hover:border-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-base-content/50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                        <p class="text-lg font-semibold mb-2">Drag & Drop your Markdown file here</p>
                        <p class="text-base-content/70 mb-4">or</p>
                        <label for="fileInput" class="btn btn-primary">
                            Browse Files
                        </label>
                        <input type="file" id="fileInput" name="file" accept=".md,.markdown" class="hidden" />
                    </div>

                    <div id="fileInfo" class="mt-4 hidden">
                        <div class="alert alert-info">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div>
                                <div class="font-semibold">File loaded:</div>
                                <div id="fileName" class="text-sm"></div>
                            </div>
                        </div>

                        <button type="submit" id="convertBtn" class="btn btn-success mt-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                            Generate Preview
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Settings Form (MOVED TO BOTTOM, COLLAPSIBLE) -->
        <div class="collapse collapse-arrow bg-base-100 shadow-xl mb-6">
            <input type="checkbox" />
            <div class="collapse-title text-xl font-medium">
                ⚙️ PDF Styling Settings
            </div>
            <div class="collapse-content">
                <form id="settingsForm">
                    <!-- Prose Settings -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-semibold">Prose Size</span>
                            </label>
                            <select name="prose_size" id="proseSize" class="select select-bordered w-full">
                                <option value="prose-sm" {% if config.prose_size == 'prose-sm' %}selected{% endif %}>Small (prose-sm)</option>
                                <option value="prose" {% if config.prose_size == 'prose' %}selected{% endif %}>Base (prose)</option>
                                <option value="prose-lg" {% if config.prose_size == 'prose-lg' %}selected{% endif %}>Large (prose-lg)</option>
                                <option value="prose-xl" {% if config.prose_size == 'prose-xl' %}selected{% endif %}>Extra Large (prose-xl)</option>
                                <option value="prose-2xl" {% if config.prose_size == 'prose-2xl' %}selected{% endif %}>2X Large (prose-2xl)</option>
                            </select>
                        </div>

                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-semibold">Prose Color</span>
                            </label>
                            <input type="text" name="prose_color" id="proseColor" value="{{ config.prose_color or '' }}"
                                   placeholder="prose-slate" class="input input-bordered w-full" />
                            <label class="label">
                                <span class="label-text-alt">Enter a Tailwind prose color class (e.g., prose-slate, prose-zinc, prose-gray)</span>
                            </label>
                        </div>
                    </div>

                    <!-- Custom Classes (COMPACT 3-COLUMN GRID) -->
                    <div class="divider">Element Styling (Tailwind Classes)</div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text text-sm">H1</span>
                            </label>
                            <input type="text" name="h1_classes" id="h1_classes" value="{{ config.custom_classes.h1 }}"
                                   placeholder="font-bold text-4xl" class="input input-bordered input-sm w-full" />
                        </div>

                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text text-sm">H2</span>
                            </label>
                            <input type="text" name="h2_classes" id="h2_classes" value="{{ config.custom_classes.h2 }}"
                                   placeholder="font-semibold text-3xl" class="input input-bordered input-sm w-full" />
                        </div>

                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text text-sm">H3</span>
                            </label>
                            <input type="text" name="h3_classes" id="h3_classes" value="{{ config.custom_classes.h3 }}"
                                   placeholder="font-medium text-2xl" class="input input-bordered input-sm w-full" />
                        </div>

                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text text-sm">H4</span>
                            </label>
                            <input type="text" name="h4_classes" id="h4_classes" value="{{ config.custom_classes.h4 }}"
                                   placeholder="font-medium text-xl" class="input input-bordered input-sm w-full" />
                        </div>

                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text text-sm">H5</span>
                            </label>
                            <input type="text" name="h5_classes" id="h5_classes" value="{{ config.custom_classes.h5 }}"
                                   placeholder="font-medium text-lg" class="input input-bordered input-sm w-full" />
                        </div>

                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text text-sm">H6</span>
                            </label>
                            <input type="text" name="h6_classes" id="h6_classes" value="{{ config.custom_classes.h6 }}"
                                   placeholder="font-medium" class="input input-bordered input-sm w-full" />
                        </div>

                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text text-sm">Paragraph</span>
                            </label>
                            <input type="text" name="p_classes" id="p_classes" value="{{ config.custom_classes.p }}"
                                   placeholder="leading-7" class="input input-bordered input-sm w-full" />
                        </div>

                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text text-sm">Links</span>
                            </label>
                            <input type="text" name="a_classes" id="a_classes" value="{{ config.custom_classes.a }}"
                                   placeholder="underline hover:no-underline" class="input input-bordered input-sm w-full" />
                        </div>

                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text text-sm">Code Block</span>
                            </label>
                            <input type="text" name="pre_classes" id="pre_classes" value="{{ config.custom_classes.pre }}"
                                   placeholder="rounded-lg p-4" class="input input-bordered input-sm w-full" />
                        </div>

                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text text-sm">Inline Code</span>
                            </label>
                            <input type="text" name="code_classes" id="code_classes" value="{{ config.custom_classes.code }}"
                                   placeholder="rounded px-1 py-0.5" class="input input-bordered input-sm w-full" />
                        </div>

                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text text-sm">Blockquote</span>
                            </label>
                            <input type="text" name="blockquote_classes" id="blockquote_classes" value="{{ config.custom_classes.blockquote }}"
                                   placeholder="border-l-4 pl-4 italic" class="input input-bordered input-sm w-full" />
                        </div>

                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text text-sm">Table</span>
                            </label>
                            <input type="text" name="table_classes" id="table_classes" value="{{ config.custom_classes.table }}"
                                   placeholder="" class="input input-bordered input-sm w-full" />
                        </div>

                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text text-sm">Table Head (thead)</span>
                            </label>
                            <input type="text" name="thead_classes" id="thead_classes" value="{{ config.custom_classes.thead }}"
                                   placeholder="" class="input input-bordered input-sm w-full" />
                        </div>

                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text text-sm">Table Body (tbody)</span>
                            </label>
                            <input type="text" name="tbody_classes" id="tbody_classes" value="{{ config.custom_classes.tbody }}"
                                   placeholder="" class="input input-bordered input-sm w-full" />
                        </div>

                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text text-sm">Table Row (tr)</span>
                            </label>
                            <input type="text" name="tr_classes" id="tr_classes" value="{{ config.custom_classes.tr }}"
                                   placeholder="" class="input input-bordered input-sm w-full" />
                        </div>

                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text text-sm">Table Cell (td)</span>
                            </label>
                            <input type="text" name="td_classes" id="td_classes" value="{{ config.custom_classes.td }}"
                                   placeholder="" class="input input-bordered input-sm w-full" />
                        </div>

                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text text-sm">Table Header (th)</span>
                            </label>
                            <input type="text" name="th_classes" id="th_classes" value="{{ config.custom_classes.th }}"
                                   placeholder="" class="input input-bordered input-sm w-full" />
                        </div>

                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text text-sm">Unordered List</span>
                            </label>
                            <input type="text" name="ul_classes" id="ul_classes" value="{{ config.custom_classes.ul }}"
                                   placeholder="" class="input input-bordered input-sm w-full" />
                        </div>

                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text text-sm">Ordered List</span>
                            </label>
                            <input type="text" name="ol_classes" id="ol_classes" value="{{ config.custom_classes.ol }}"
                                   placeholder="" class="input input-bordered input-sm w-full" />
                        </div>

                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text text-sm">List Item</span>
                            </label>
                            <input type="text" name="li_classes" id="li_classes" value="{{ config.custom_classes.li }}"
                                   placeholder="" class="input input-bordered input-sm w-full" />
                        </div>

                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text text-sm">Horizontal Rule</span>
                            </label>
                            <input type="text" name="hr_classes" id="hr_classes" value="{{ config.custom_classes.hr }}"
                                   placeholder="" class="input input-bordered input-sm w-full" />
                        </div>

                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text text-sm">Image</span>
                            </label>
                            <input type="text" name="img_classes" id="img_classes" value="{{ config.custom_classes.img }}"
                                   placeholder="" class="input input-bordered input-sm w-full" />
                        </div>
                    </div>

                    <div class="mt-6 flex gap-2">
                        <button type="submit" id="saveBtn" class="btn btn-primary" disabled>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                            Save Settings
                        </button>
                        <button type="button" id="revertBtn" class="btn btn-outline btn-warning" disabled>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            Revert to Saved
                        </button>
                        <button type="button" id="factoryResetBtn" class="btn btn-outline btn-error">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            Factory Reset
                        </button>
                    </div>

                    <div class="mt-4 text-sm text-base-content/70">
                        <p>📚 Browse available Tailwind CSS classes: <a href="https://tailwindcss.com/docs" target="_blank" rel="noopener noreferrer" class="link link-primary">Tailwind Documentation</a></p>
                        <p>🎨 For prose colors and typography: <a href="https://tailwindcss.com/docs/typography-plugin" target="_blank" rel="noopener noreferrer" class="link link-primary">Typography Plugin</a></p>
                    </div>
                </form>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="statusMessage" class="hidden"></div>
    </div>

    <!-- Loading Modal -->
    <dialog id="loadingModal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Processing...</h3>
            <div class="py-4 flex justify-center">
                <span class="loading loading-spinner loading-lg"></span>
            </div>
            <p class="text-center" id="loadingMessage">Please wait while your PDF is being generated</p>
        </div>
    </dialog>

    <!-- Unsaved Changes Modal -->
    <dialog id="unsavedModal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">⚠️ Unsaved Settings</h3>
            <p class="py-4">You have unsaved styling changes. What would you like to do?</p>
            <div class="modal-action">
                <button id="generateWithoutSaving" class="btn btn-ghost">
                    Generate Without Saving
                </button>
                <button id="saveAndGenerate" class="btn btn-primary">
                    Save Settings & Generate
                </button>
            </div>
        </div>
    </dialog>

    <!-- Factory Reset Confirmation Modal -->
    <dialog id="factoryResetModal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">🔄 Factory Reset</h3>
            <p class="py-4">This will reset all styling settings to factory defaults. This action cannot be undone. Are you sure?</p>
            <div class="modal-action">
                <button id="cancelFactoryReset" class="btn btn-ghost">
                    Cancel
                </button>
                <button id="confirmFactoryReset" class="btn btn-error">
                    Reset to Factory Defaults
                </button>
            </div>
        </div>
    </dialog>

    <script>
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const uploadForm = document.getElementById('uploadForm');
        const settingsForm = document.getElementById('settingsForm');
        const loadingModal = document.getElementById('loadingModal');
        const loadingMessage = document.getElementById('loadingMessage');
        const unsavedModal = document.getElementById('unsavedModal');
        const factoryResetModal = document.getElementById('factoryResetModal');
        const saveBtn = document.getElementById('saveBtn');
        const revertBtn = document.getElementById('revertBtn');
        const factoryResetBtn = document.getElementById('factoryResetBtn');

        let currentFile = null;
        let savedConfig = {};
        let hasUnsavedChanges = false;

        // Field names for tracking
        const fieldNames = ['h1_classes', 'h2_classes', 'h3_classes', 'h4_classes', 'h5_classes', 'h6_classes',
                           'p_classes', 'a_classes', 'code_classes', 'pre_classes', 'blockquote_classes',
                           'table_classes', 'thead_classes', 'tbody_classes', 'tr_classes', 'td_classes', 'th_classes',
                           'ul_classes', 'ol_classes', 'li_classes', 'hr_classes', 'img_classes'];

        // Load saved config on page load
        async function loadSavedConfig() {
            try {
                const response = await fetch('/api/config');
                savedConfig = await response.json();
                updateAllFieldIndicators();
            } catch (error) {
                console.error('Failed to load config:', error);
            }
        }

        // Compare current form values with saved config
        function checkForChanges() {
            const proseSize = document.getElementById('proseSize').value;
            const proseColor = document.getElementById('proseColor').value.trim();

            let hasChanges = proseSize !== savedConfig.prose_size ||
                           proseColor !== (savedConfig.prose_color || '');

            fieldNames.forEach(fieldName => {
                const input = document.getElementById(fieldName);
                const elementName = fieldName.replace('_classes', '');
                const savedValue = savedConfig.custom_classes[elementName] || '';
                const currentValue = input.value.trim();

                if (savedValue !== currentValue) {
                    hasChanges = true;
                }
            });

            hasUnsavedChanges = hasChanges;
            saveBtn.disabled = !hasChanges;
            revertBtn.disabled = !hasChanges;

            if (!hasChanges) {
                saveBtn.classList.add('btn-disabled');
            } else {
                saveBtn.classList.remove('btn-disabled');
            }
        }

        // Update visual indicator for a single field
        function updateFieldIndicator(inputElement, fieldName) {
            const elementName = fieldName.replace('_classes', '');
            const savedValue = savedConfig.custom_classes?.[elementName] || '';
            const currentValue = inputElement.value.trim();

            inputElement.classList.remove('input-synced', 'input-modified');

            if (savedValue === currentValue) {
                inputElement.classList.add('input-synced');
            } else {
                inputElement.classList.add('input-modified');
            }
        }

        // Update all field indicators
        function updateAllFieldIndicators() {
            fieldNames.forEach(fieldName => {
                const input = document.getElementById(fieldName);
                if (input) {
                    updateFieldIndicator(input, fieldName);
                }
            });

            // Check prose size
            const proseSize = document.getElementById('proseSize');
            proseSize.classList.remove('input-synced', 'input-modified');
            if (proseSize.value === savedConfig.prose_size) {
                proseSize.classList.add('input-synced');
            } else {
                proseSize.classList.add('input-modified');
            }

            // Check prose color
            const proseColor = document.getElementById('proseColor');
            proseColor.classList.remove('input-synced', 'input-modified');
            if (proseColor.value.trim() === (savedConfig.prose_color || '')) {
                proseColor.classList.add('input-synced');
            } else {
                proseColor.classList.add('input-modified');
            }
        }

        // Collect current form configuration as JSON
        function getCurrentConfig() {
            const config = {
                prose_size: document.getElementById('proseSize').value,
                prose_color: document.getElementById('proseColor').value.trim(),
                custom_classes: {},
                pdf_options: savedConfig.pdf_options || {}
            };

            fieldNames.forEach(fieldName => {
                const input = document.getElementById(fieldName);
                const elementName = fieldName.replace('_classes', '');
                config.custom_classes[elementName] = input.value.trim();
            });

            return config;
        }

        // Add input listeners to all fields
        fieldNames.forEach(fieldName => {
            const input = document.getElementById(fieldName);
            if (input) {
                input.addEventListener('input', () => {
                    updateFieldIndicator(input, fieldName);
                    checkForChanges();
                });
            }
        });

        // Prose size and color change listeners
        document.getElementById('proseSize').addEventListener('change', () => {
            updateAllFieldIndicators();
            checkForChanges();
        });

        document.getElementById('proseColor').addEventListener('input', () => {
            updateAllFieldIndicators();
            checkForChanges();
        });

        // Revert button handler
        revertBtn.addEventListener('click', () => {
            // Reload form with saved config
            document.getElementById('proseSize').value = savedConfig.prose_size;
            document.getElementById('proseColor').value = savedConfig.prose_color || '';

            fieldNames.forEach(fieldName => {
                const input = document.getElementById(fieldName);
                const elementName = fieldName.replace('_classes', '');
                input.value = savedConfig.custom_classes[elementName] || '';
            });

            updateAllFieldIndicators();
            checkForChanges();
        });

        // Factory Reset button handler
        factoryResetBtn.addEventListener('click', () => {
            factoryResetModal.showModal();
        });

        document.getElementById('cancelFactoryReset').addEventListener('click', () => {
            factoryResetModal.close();
        });

        document.getElementById('confirmFactoryReset').addEventListener('click', async () => {
            try {
                // Fetch factory defaults
                const response = await fetch('/api/config/factory-reset');
                const factoryConfig = await response.json();

                // Update form with factory defaults
                document.getElementById('proseSize').value = factoryConfig.prose_size;
                document.getElementById('proseColor').value = factoryConfig.prose_color || '';

                fieldNames.forEach(fieldName => {
                    const input = document.getElementById(fieldName);
                    const elementName = fieldName.replace('_classes', '');
                    input.value = factoryConfig.custom_classes[elementName] || '';
                });

                // Close modal
                factoryResetModal.close();

                // Update indicators and check for changes
                updateAllFieldIndicators();
                checkForChanges();

                // Show success message
                alert('Settings reset to factory defaults. Click "Save Settings" to apply permanently.');
            } catch (error) {
                console.error('Factory reset failed:', error);
                alert('Failed to load factory defaults. Please try again.');
            }
        });

        // Drag and drop functionality
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.classList.add('drag-over');
            });
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.classList.remove('drag-over');
            });
        });

        dropZone.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            handleFiles(files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            if (files.length > 0) {
                const file = files[0];
                if (file.name.endsWith('.md') || file.name.endsWith('.markdown')) {
                    currentFile = file;
                    fileName.textContent = file.name;
                    fileInfo.classList.remove('hidden');
                } else {
                    showStatus('Please upload a valid Markdown file (.md or .markdown)', 'error');
                }
            }
        }

        // Settings form submission
        settingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            loadingMessage.textContent = 'Saving settings...';
            loadingModal.showModal();

            const formData = new FormData(settingsForm);

            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                loadingModal.close();

                if (response.ok) {
                    showStatus('Settings saved successfully!', 'success');
                    // Reload saved config
                    await loadSavedConfig();
                    // Reset the unsaved changes flag
                    checkForChanges();
                } else {
                    showStatus('Error saving settings', 'error');
                }
            } catch (error) {
                loadingModal.close();
                showStatus('Error: ' + error.message, 'error');
            }
        });

        // Upload form submission with unsaved changes check
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentFile) {
                showStatus('Please select a file first', 'error');
                return;
            }

            // Check for unsaved changes
            if (hasUnsavedChanges) {
                unsavedModal.showModal();
                return;
            }

            // Proceed with upload
            await processUpload();
        });

        // Unsaved modal handlers
        document.getElementById('generateWithoutSaving').addEventListener('click', async () => {
            unsavedModal.close();
            // Send temp config to server for preview
            await processUpload(true);
        });

        document.getElementById('saveAndGenerate').addEventListener('click', async () => {
            unsavedModal.close();

            // Save settings first
            loadingMessage.textContent = 'Saving settings...';
            loadingModal.showModal();

            const formData = new FormData(settingsForm);

            try {
                await fetch('/api/config', {
                    method: 'POST',
                    body: formData
                });

                await loadSavedConfig();
                // Use saved config, no need for temp config
                await processUpload(false);
            } catch (error) {
                loadingModal.close();
                showStatus('Error saving settings: ' + error.message, 'error');
            }
        });

        // Process file upload
        async function processUpload(useTempConfig = false) {
            loadingMessage.textContent = 'Processing markdown file...';
            loadingModal.showModal();

            const formData = new FormData();
            formData.append('file', currentFile);

            // If using temp config, send current form values
            if (useTempConfig) {
                const currentConfig = getCurrentConfig();
                const configJson = JSON.stringify(currentConfig);
                formData.append('temp_config', configJson);
            }

            try {
                const response = await fetch('/api/convert', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    loadingModal.close();

                    if (result.status === 'success') {
                        // Navigate directly to preview page
                        window.location.href = result.preview_url;
                    } else {
                        showStatus('Error: ' + result.message, 'error');
                    }
                } else {
                    const error = await response.json();
                    loadingModal.close();
                    showStatus('Error processing file: ' + error.error, 'error');
                }
            } catch (error) {
                loadingModal.close();
                showStatus('Error: ' + error.message, 'error');
            }
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
            const icon = type === 'success'
                ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />'
                : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />';

            statusDiv.innerHTML = `
                <div class="alert ${alertClass} shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                        ${icon}
                    </svg>
                    <span>${message}</span>
                </div>
            `;
            statusDiv.classList.remove('hidden');

            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 5000);
        }

        // Initialize on page load
        loadSavedConfig();
    </script>
</body>
</html>
